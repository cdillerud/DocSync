<analysis>**original_problem_statement:**
Build a minimal but production-style “GPI Document Hub” test platform to replace Zetadocs-style document linking in Microsoft Dynamics 365 Business Central. The hub will use SharePoint Online as the document repository and a middleware hub to orchestrate ingestion, metadata, approvals, and attachment linking back to BC.

PRODUCT REQUIREMENTS:
-   **Architecture:** A hub-and-spoke model with a FastAPI backend and a React frontend. The spokes are Business Central (BC) and SharePoint Online.
-   **Authentication:** Use Entra ID (Azure AD) application with client credentials for both BC and Microsoft Graph APIs.
-   **Data Model:**
    -   : Stores metadata about each document, including file info, SharePoint URLs, BC record details, and status.
    -   : Logs the execution of each workflow for auditing.
-   **Core Workflows:**
    1.  **Manual Upload & Link:** A UI to upload a file, associate it with a BC Sales Order, upload it to a specific SharePoint folder, create a sharing link, and attach the document/link back to the BC record.
    2.  **Document Queue:** A UI to view and manage documents that are not fully processed.
    3.  **Audit & Monitoring:** A dashboard to display system status, recent runs, and failures.
-   **Success Criteria:** A user can upload a PDF, associate it with a BC Sales Order, find the file in SharePoint, and access the document from within the BC Sales Order record. The system must be stable and provide clear audit logs.

**User's preferred language**: English

**what currently exists?**
A full-stack application with a FastAPI backend, MongoDB database, and a React frontend.
-   **Frontend:** Features a login page, a settings page for credentials, a document upload page, a document queue, and a document detail view.
-   **Backend:** Supports user authentication (mock), credential management (stored in DB), document upload, and workflows.
-   **Integrations:**
    -   **SharePoint:** Successfully uploads files to the correct folders and creates sharing links.
    -   **Business Central (BC):** After extensive debugging of permissions, the connection is now **working**. The application can successfully query for sales orders from the  environment.
-   **Functionality:** Users can configure credentials, upload documents, and see them processed. Failed documents can be resubmitted or deleted. The system correctly identifies and reports API errors.

**Last working item**:
-   **Last item agent was working:** Implementing the final, critical step of the core workflow: attaching the uploaded document file directly to the corresponding Sales Order record within Business Central. The agent successfully proved this was possible using the  API via  and was about to implement this logic into the Python backend service.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N (Only manual  testing was performed to validate the API endpoint. The integrated code has not been written or tested.)
-   **Which testing method agent to use?** both
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
There are no outstanding issues. The last working item is a task in progress.

**In progress Task List**:
-   **Task 1:** Complete the implementation of attaching documents to Business Central Sales Orders. (P0)
    -   **Where to resume:** Modify the  function in . The function should be updated to read the locally stored file (from the  directory) and POST its content to the BC  API endpoint for the specified sales order. The successful  commands from message #418 serve as a direct template for this implementation.
    -   **What will be achieved with this?** This will complete the primary success criteria of the project, allowing a user in Business Central to see and open the document directly from the Sales Order record.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** No.

**Upcoming and Future Tasks**
**Upcoming Tasks:**
-   **Task 1 (P1):** Implement writing the SharePoint URL back to the BC record as a note/comment, in addition to the file attachment. This provides a secondary access method.
-   **Task 2 (P1):** Fully implement the Document Queue UI functionality (Workflow 2), allowing users to edit metadata (, , etc.) and trigger the linking process for queued documents.
-   **Task 3 (P2):** Build the Audit and Monitoring dashboard UI (Workflow 3) to show statistics, recent workflow runs, and filterable error logs.

**Future Tasks (Phase 2):**
-   Implement Exchange Online email ingestion.
-   Add a placeholder for an AI document classification step.
-   Add a mapping layer for document sets concept.
-   Integrate Entra ID SSO for UI authentication.

**Completed work in this session**
-   **Full-stack Application Scaffold:** Created a FastAPI backend and React frontend with a complete project structure.
-   **Database & Models:** Implemented MongoDB for data persistence with  and  models.
-   **UI Development:**
    -   Created pages for Login, Dashboard, Upload, Document Queue, Document Detail, and Settings.
    -   Implemented a Configure Credentials dialog on the Settings page to manage API keys, which are stored securely in the database.
-   **Core Workflow Implementation:**
    -   Implemented document upload, which saves the file locally to .
    -   Integrated with SharePoint to upload the file and create a sharing link.
-   **Critical Integration Debugging:**
    -   Resolved numerous complex authentication and permission issues with both Microsoft Graph and Business Central APIs.
    -   **Key BC Fix:** Identified that the tenant has a default  entitlement block. Discovered that adding the **** permission set alongside **** in the BC Entra Application setup successfully overrides this block.
    -   Switched to and configured the  BC environment, which is now working.
-   **Feature Enhancements:**
    -   Added a Re-submit button for failed workflows (single click, no re-upload required).
    -   Added a Delete button to remove documents from the queue.
    -   Made the BC sales order search non-blocking, allowing manual entry if the API search fails, improving user experience.

**Earlier issues found/mentioned but not fixed**
- None. All major issues, especially the critical BC permission blockers, were resolved during the session.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Pydantic
-   **Frontend:** React, Tailwind CSS, Shadcn/UI
-   **Database:** MongoDB
-   **Authentication:** JWT for local UI auth, Client Credentials Flow for service-to-service API calls to Microsoft.
-   **APIs:** Microsoft Graph API (for SharePoint), Dynamics 365 Business Central v2.0 API.

**key DB schema**
-   ** (collection):** 
-   ** (collection):** 
-   ** (collection):** A single document storing all configuration from the UI, e.g., .

**changes in tech stack**
-   The application uses MongoDB, which was one of the suggested options.
-   Configuration management was moved from  files to a dedicated MongoDB collection to prevent server restarts upon saving settings from the UI.

**All files of reference**
-   : Contains all logic for interacting with the Business Central API. **This is the next file to be modified.**
-   : Contains all logic for interacting with the Microsoft Graph API for SharePoint.
-   : Defines the API endpoints for document upload, resubmission, and deletion.
-   : Handles loading configuration from both  and the MongoDB database.
-   : The UI for configuring credentials.
-   : The UI for uploading new documents.
-   : Shows details for a single document, including the re-submit button.

**Areas that need refactoring**:
-   The  service file contains commented-out code and debugging logic from the extensive permission troubleshooting. Now that a stable solution is found, this file could be cleaned up to only contain the working API call logic.

**key api endpoints**
-   : Uploads a new document.
-   : Re-runs the linking workflow for a failed document.
-   : Deletes a document and its stored file.
-   : Searches for sales orders in Business Central.
-   : Retrieves the current configuration from the database.
-   : Saves new configuration to the database.
-   : Tests the credentials for BC and SharePoint.

**Critical Info for New Agent**
-   **BC Permissions are Solved:** The Business Central API is now accessible. The required setup in the BC Microsoft Entra Applications page is to assign both **** and **** permission sets. This overrides a tenant-level exclusion policy ().
-   **Active BC Environment:** The application is configured to use the **** environment. Do not use the other sandboxes as they are poisoned by a cached permission exclusion.
-   **Config is in MongoDB:** All credentials and settings entered via the UI are stored in a  collection in MongoDB, not in the  file. The  file is only used for initial bootstrap.
-   **Local File Storage:** Uploaded files are temporarily stored in the  directory before being sent to SharePoint and attached to BC. This is used for the re-submit functionality.

**documents and test reports created in this job**
-   
-   Test reports from previous iterations exist in .

**Last 10 User Messages and any pending HUMAN messages**
1.  **user:** Asks how a user in BC can access the linked document. (PENDING full implementation)
2.  **agent:** Confirms that the BC API supports attachments and that this will be the implementation method.
3.  **user:** Notes a Zetadocs (old system) error in the BC UI.
4.  **agent:** Clarifies that the Zetadocs error is separate and won't affect the hub's API-based approach.
5.  **user:** Confirms setup is done for the new sandbox.
6.  **agent:** **Confirms the BC connection is finally working** and can query real sales order data.
7.  **agent:** Suggests adding the  permission set in BC to solve the final blocker.
8.  **user:**  (referring to setting up the new sandbox ).
9.  **agent:** Asks user to set up the new sandbox () with  permissions only to get a clean slate.
10. **user:** Expresses frustration that BC is the most important part and must work.

**Project Health Check:**
-   **Working:** Frontend UI, SharePoint Integration, Settings Management, Document Upload/Queue, Resubmit/Delete, Audit Logging.
-   **In Progress:** The final step of the Business Central integration (attaching the file) is being implemented.
-   **Broken:** Nothing is currently broken. The main blocker (BC permissions) has been resolved.

**3rd Party Integrations**
-   **Microsoft Graph API:** Used for SharePoint file operations.
-   **Dynamics 365 Business Central API:** Used for validating and attaching documents to Sales Orders.

**Testing status**
-   **Testing agent used after significant changes:** YES (but not for the most recent changes).
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
All necessary credentials for SharePoint and Business Central have been successfully entered by the user and are stored in the application's database. The agent does not need to ask for them again.

**What agent forgot to execute**
- The agent has not yet implemented the user's request to also write the SharePoint link as a **note/comment** back to the BC Sales Order, in addition to attaching the file. This should be added to the upcoming task list.</analysis>
