<analysis>**original_problem_statement:**
The user's primary objective is to build a GPI Document Hub to replace their legacy Square9 and Zetadocs systems. This involves creating a unified document processing queue, a central dashboard, and integrating with Business Central (BC).

A significant new feature request was added: build a complete Accounts Payable Invoice Automation module within the existing hub to replicate the Zetadocs AP workflow. This includes:
1.  **AP Invoice Review Workspace:** A new UI with a PDF preview and editable fields for extracted invoice data.
2.  **BusinessCentralService:** A backend integration layer for real-time communication with BC (vendor search, PO search, purchase invoice creation).
3.  **Extended Document Model:** Adding fields to the schema for BC posting status, IDs, and errors.
4.  **Document Posting Workflow:** Logic to validate and post an invoice to BC when a user clicks Post to BC.
5.  **Outbound Document Delivery Module:** A future-scoped module to query and email posted sales invoices.

The immediate goal is to implement the **AP Invoice Review Workspace** and the **BC Posting Integration** (Phases 1 and 2), connecting them to the user's real BC Sandbox environment for end-to-end testing.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack document processing hub (FastAPI/React/MongoDB). It features a document queue, dashboard, and AI-powered classification. The system has been successfully connected to the user's real **Business Central (BC) Sandbox** and **SharePoint** environments using user-provided credentials.

A new **AP Review Workspace** has been implemented. When viewing an AP Invoice, the UI now shows a PDF preview alongside an editable form for invoice data. This workspace is connected to the real BC Sandbox, allowing users to search for and select real vendors and purchase orders. The original Square9 workflow logic has been replicated, where documents are validated and stored in SharePoint without being automatically attached in BC.

**Last working item**:
- **Last item agent was working:** The agent was debugging a  error received from the real Business Central API when attempting to post a Purchase Invoice from the new AP Review workspace. The agent identified from the logs that the error was , indicating the JSON payload sent to BC was using an incorrect field name.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** backend testing agent
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: (P0) BC Purchase Invoice Posting Fails with 400 Bad Request.**
- **Issue 2: (P1) Document Queue status is inconsistent with Detail Page.**
- **Issue 3: (P1) Backend Refactor is Incomplete.**
- **Issue 4: (P2) Fuzzy Matching logic may still need improvement.**

**Issues Detail:**
- **Issue 1: BC Purchase Invoice Posting Fails with 400 Bad Request**
    - **Description:** When the user clicks Post to BC in the AP Review workspace, the backend service attempts to create a purchase invoice in the real BC Sandbox but receives a 400 Bad Request. The logs show the BC API rejected the request because the payload contains an invalid property: .
    - **Attempted fixes:** The agent successfully identified the specific error message from the logs.
    - **Next debug checklist:**
        1.  Examine the  method in .
        2.  Search the web for Business Central purchaseInvoices API documentation to find the correct field name for the external invoice number (it is likely ).
        3.  Update the payload construction logic in  to use the correct field name.
        4.  Use  against the container's IP to re-test the  endpoint.
    - **Why fix this issue and what will be achieved with the fix?** This is the final and most critical step of the Zetadocs AP automation workflow. Fixing it will enable end-to-end testing of the entire AP posting pipeline.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Backend
- **Issue 2: Document Queue status is inconsistent with Detail Page**
    - **Description:** The user reported that a document shows as Validated on the detail page, but the main Document Queue page still shows its status as Vendor Pending. This is because the  logic updates the document's  but not the  field that the queue page displays.
    - **Attempted fixes:** The agent created a python script () to patch the logic but it was never run on the user's VM as the focus shifted.
    - **Next debug checklist:**
        1.  Locate the  function in .
        2.  Modify the database update logic within this function to set the  and  fields in addition to the  field (e.g., set  to validated).
        3.  Test by reprocessing a document that is stuck in the Vendor Pending state.
    - **Why fix this issue and what will be achieved with the fix?** This fix will provide a consistent user experience and remove confusion about a document's true state.
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Both
- **Issue 3: Backend Refactor is Incomplete**
    - **Description:** The main  file is still a monolith containing most of the application's endpoints, making it difficult to maintain and debug.
    - **Next debug checklist:** Continue the refactoring process by moving logical groups of endpoints (e.g., document management, dashboard stats) into separate router files under .
    - **Why fix this issue and what will be achieved with the fix?** Simplifies the architecture, which is a primary goal for the user, and improves maintainability.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Backend
- **Issue 4: Improve Fuzzy Matching to eliminate aliases**
    - **Description:** The user wants the system to be smart enough to match vendor names without requiring manual aliases (e.g., match TUMALO CREEK TRANSPORTATION to Tumalo Creek Transportation).
    - **Attempted fixes:** The vendor search logic was updated to use a  query on the BC API, which is more efficient than fetching all vendors.
    - **Next debug checklist:** The effectiveness of this change has not been fully validated by the user. Further improvements may involve more advanced fuzzy matching libraries or algorithms on the backend if the current filter is insufficient.
    - **Why fix this issue and what will be achieved with the fix?** Reduces manual configuration and addresses a major user frustration.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Backend

**In progress Task List**:
- **Task 1: Complete Phase 2 - BC Posting Integration (P0)**
    - **Where to resume:** In , fix the payload in the  method.
    - **What will be achieved with this?** A fully functional, end-to-end workflow for posting AP Invoices from the GPI Hub into the real BC Sandbox.
    - **Status:** IN PROGRESS
    - **Blocked on something:** No.

**Upcoming and Future Tasks**
**Upcoming Tasks:**
-   **Task 1 (P1):** Implement the Outbound Document Delivery module for emailing posted sales invoices.
-   **Task 2 (P2):** Define Stable Vendor as a metric and implement Phase 8 (Controlled Vendor Enablement for automated draft creation).

**Future Tasks:**
-   Replace the mock email service with a real provider.
-   Implement multi-step approval routing.
-   Implement a Vendor Threshold Override architecture.
-   Plan and execute the full decommissioning of the legacy Zetadocs system.
-   Implement automated creation of Purchase Invoice *lines* in BC.
-   Replace mock JWT auth with Entra ID SSO.

**Completed work in this session**
-   **Square9 Workflow Alignment (DONE):** Fixed the  logic to correctly validate documents and store them in SharePoint without attempting a premature BC attachment, resolving the  vs  bug.
-   **Production Environment Debugging (DONE):** Diagnosed and created patches for path divergences ( vs ) between the preview and the user's production VM. Also resolved Docker networking issues ( vs container IP).
-   **Warehouse Document Enhancement (DONE):** Updated the  job type with required fields (, ) and improved the AI extraction prompt to successfully extract data from Bills of Lading (BOLs).
-   **AP Review Workspace (Phase 1 & 2) (DONE):**
    -   Created a  and  router in the backend.
    -   Created  and  components in the frontend.
    -   Integrated the new UI into the Document Detail page for AP Invoices.
-   **Real BC Sandbox & SharePoint Integration (DONE):** Successfully configured the application with user-provided credentials to connect to the real BC Sandbox and SharePoint. Vendor and PO lookups in the AP Review workspace are now powered by live data.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Document Queue status is inconsistent with Detail Page**
    -   **Debug checklist:** The agent identified the root cause ( not being updated) and prepared a fix script, but the user did not run it. The fix needs to be applied to the  function in .
    -   **Why to solve this issue and what will be achieved with this?** To ensure UI consistency and avoid user confusion.
    -   **Should Test frontend/backend/both after fix:** Both.
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
- **Configuration & Environment Divergence:** The agent again encountered issues due to differences between the preview environment and the user's production VM (e.g., file paths for , database names, required  variables). This remains a persistent risk.

**Code Architecture**


**Key Technical Concepts**
-   **Real-time VM Debugging:** Extensive use of , , and on-the-fly Python patching scripts to debug and fix issues directly on the user's production VM.
-   **Docker Networking:** Encountered and solved issues where  did not resolve to the container, requiring the use of the container's internal IP address for testing.
-   **BC API Integration:** Interfaced with the real Business Central OData API, including debugging filter syntax and payload structures for .
-   **Environment Configuration:** Managed multiple sets of credentials for different services (BC API, MS Graph API) and ensured they were correctly loaded from  files.

**key DB schema**
-   ****: The schema needs to be extended to support the AP workflow. The following fields were specified but **have not yet been added**: , , , , , , .
-   ** (Enum in code):** The  state was added to represent the Square9 workflow completion state.

**All files of reference**
-   **/app/backend/server.py**: Heavily modified to fix Square9 workflow logic and enhance shipping document processing. Still the architectural monolith.
-   **/app/backend/services/business_central_service.py**: **New file** that encapsulates all logic for interacting with the Business Central API.
-   **/app/backend/routes/ap_review.py**: **New file** containing API endpoints for the AP Review workspace.
-   **/app/frontend/src/pages/DocumentDetailPage.js**: Modified to conditionally render the new  and  for AP Invoices.
-   **/app/frontend/src/components/APReviewPanel.js**: **New file** for the AP invoice review form.
-   **/app/frontend/src/components/PDFPreview.js**: **New file** for embedding and viewing PDF documents.
-   **/app/backend/.env**: Updated with real, user-provided credentials for BC and MS Graph.

**Areas that need refactoring**:
-   **/app/backend/server.py**: This remains the highest priority for refactoring. It contains over 12,000 lines of code.
-   **Environment Synchronization:** A strategy is needed to align the preview and production environments to prevent recurring path and configuration issues.
-   **BC Payload Construction:** The logic for building the  payload should be more robust and validated against the BC schema, potentially using Pydantic models.

**key api endpoints**
-   : Creates a Purchase Invoice in BC. **(Currently failing with 400)**.
-   : Searches for vendors in BC.
-   : Searches for open POs for a vendor in BC.
-   : Serves the document file for the PDF previewer.
-   : The endpoint that was fixed to align with Square9 workflow.

**Critical Info for New Agent**
-   **The application is connected to the user's REAL BC Sandbox and SharePoint.** Be cautious with any operations that write data.
-   **You will be debugging on the user's production VM.** The environment has known differences from the preview (e.g.,  path).
-   **Use container IP for  tests.** On the user's VM,  does not correctly route to the backend container. Use  to get the IP address.
-   **The immediate priority is the BC posting bug.** Fix the  on . After that, address the inconsistent status in the document queue.
-   **The document model has not been updated yet.** The schema in MongoDB is missing fields like  and . These will need to be added to fully complete the posting workflow.

**documents and test reports created in this job**
-    (updated with AP Automation requirements)
-   Temporary patch scripts created on the user's VM: , , , . The logic from these scripts has been integrated into the codebase.

**Last 10 User Messages and any pending HUMAN messages**
1.  **user**: (Provides screenshot) The document detail page is not updating with the newly extracted BOL fields.
2.  **user**: (Provides screenshot) The extraction completeness calculation is still wrong.
3.  **user**: (Confirms commands to run) 
4.  **user**: (Reports error)  - curl response was empty.
5.  **user**: (Provides a large prompt detailing the Zetadocs AP automation feature to be built).
6.  **user**: (Provides a more detailed, phased prompt for building the AP Review Workspace and BC Posting integration).
7.  **user**: (Provides credentials) for the Business Central API App registration.
8.  **user**: Asks if the agent is connecting to SharePoint.
9.  **user**: (Provides credentials) for the IT Help Desk Email Integration Application to be used for Graph/SharePoint.
10. **user**: (Provides a duplicate of the large feature request prompt).

**Project Health Check:**
-   **Broken:**
    -   **Purchase Invoice Posting:** The core function to create an invoice in BC is failing with a 400 Bad Request due to an incorrect payload.
-   **Mocked:**
    -   None. The system is fully connected to the BC Sandbox and SharePoint.

**3rd Party Integrations**
-   **Dynamics 365 Business Central API:** ✅ Live, real-time read/write connection to the user's  environment.
-   **Microsoft Graph API / SharePoint:** ✅ Live, real-time connection for file storage in the  SharePoint site.
-   **Gemini (via Emergent LLM Key):** Used for document classification and extraction.
-   **APScheduler:** Used for scheduled background jobs like email polling.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None. Testing was performed manually via  and by observing UI behavior.
-   **Known regressions:** None.

**Credentials to test flow:**
-   Web UI:  / 

**What agent forgot to execute**
-   The agent did not fix the  display bug on the Document Queue page, which the user pointed out.
-   The agent did not add the new required fields (, , etc.) to the  schema in MongoDB, which is a necessary step for the posting workflow to be complete.</analysis>
